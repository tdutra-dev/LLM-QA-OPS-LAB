{"version":3,"file":"MockLLMAdapter.js","sourceRoot":"","sources":["../src/MockLLMAdapter.ts"],"names":[],"mappings":"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","sourcesContent":["import { z } from \"zod\";\nimport { FeatureSpec, TestCaseSchema } from \"@llmqa/core\";\nimport { LLMAdapter } from \"./LLMAdapter.js\";\nimport { PromptEngine } from \"./prompt/PromptEngine.js\";\nimport { MockModelClient } from \"./model/MockModelClient.js\";\nimport { withFallback } from \"./infra/resilience/withFallback.js\";\nimport { withResilience } from \"./infra/resilience/withResilience.js\";\nimport { buildJsonRepairPrompt } from \"./output/recovery.js\";\nimport { safeJsonParse } from \"./utils/json.js\";\nimport { metrics } from \"./infra/metrics/index.js\";\n\nconst ModelOutputSchema = z.object({\n  testCases: z.array(TestCaseSchema),\n});\n\nexport class MockLLMAdapter implements LLMAdapter {\n  private promptEngine = new PromptEngine();\n  private model = new MockModelClient();\n\n  async generateTestCases(spec: FeatureSpec) {\n    metrics.incRequests();\n\n    const prompt = await this.promptEngine.buildPrompt(\n      { name: \"generate_testcases\", version: \"v1\" },\n      spec\n    );\n\n    // üü° PRIMARY\n    const primaryCall = () =>\n      withResilience(\n        ({ signal }) => this.model.complete(prompt, { signal }),\n        {\n          timeoutMs: 1000,\n          maxAttempts: 3,\n          baseDelayMs: 250,\n          maxDelayMs: 4000,\n          onAttempt: ({ attempt }) =>\n            console.log(`üü° [primary] attempt=${attempt}`),\n          onRetry: ({ attempt, delayMs, decision, err }) =>\n            console.log(\n              `üîÅ [primary] retry after attempt=${attempt} delay=${delayMs} reason=${decision.reason} err=${(err as any)?.name}`\n            ),\n        }\n      );\n\n    // üü¢ SECONDARY\n    const secondaryCall = () =>\n      withResilience(\n        ({ signal }) => this.model.complete(prompt, { signal }),\n        {\n          timeoutMs: 1500,\n          maxAttempts: 1,\n          baseDelayMs: 250,\n          maxDelayMs: 4000,\n          onAttempt: ({ attempt }) =>\n            console.log(`üü¢ [secondary] attempt=${attempt}`),\n        }\n      );\n\n    const raw = await withFallback(primaryCall, secondaryCall, {\n      primaryName: \"mock-primary\",\n      secondaryName: \"mock-secondary\",\n      onFallback: ({ from, to, err }) =>\n        console.log(\n          `üõü [fallback] from=${from} to=${to} err=${(err as any)?.name}`\n        ),\n    });\n\n    let parsed;\n    try {\n      parsed = safeJsonParse(raw);\n      const validated = ModelOutputSchema.parse(parsed);\n      return validated.testCases;\n    } catch (err) {\n      console.log(\"‚ö†Ô∏è validation failed, attempting recovery...\");\n      metrics.incRecoveryAttempts();\n\n      const repairPrompt = buildJsonRepairPrompt(raw);\n\n      const repairedRaw = await this.model.complete(repairPrompt);\n\n      parsed = safeJsonParse(repairedRaw);\n      const validated = ModelOutputSchema.parse(parsed);\n\n      metrics.incRecoverySuccesses(); // counts successful recoveries\n      console.log(\"‚úÖ recovery successful\");\n      return validated.testCases;\n    }\n  }\n}\n"]}