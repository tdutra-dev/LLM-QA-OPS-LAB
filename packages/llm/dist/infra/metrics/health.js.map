{"version":3,"file":"health.js","sourceRoot":"","sources":["../../../src/infra/metrics/health.ts"],"names":[],"mappings":"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","sourcesContent":["import { kpiRules } from \"./rules.js\";\n\nexport type HealthStatus = \"OK\" | \"WARN\" | \"CRITICAL\";\n\nexport function evaluateHealth(input: {\n  requests: number;\n  attempts: number;\n  retries: number;\n  fallbacks: number;\n  recoveryAttempts: number;\n  recoverySuccesses: number;\n}) {\n  const issues: string[] = [];\n  const actions: string[] = [];\n\n  const retryRate = input.attempts === 0 ? 0 : input.retries / input.attempts;\n  const fallbackRate = input.requests === 0 ? 0 : input.fallbacks / input.requests;\n\n  const recoveryFailRate =\n    input.recoveryAttempts === 0\n      ? 0\n      : 1 - input.recoverySuccesses / input.recoveryAttempts;\n\n  // Retry\n  if (retryRate >= kpiRules.retryRateCritical)\n    issues.push(`retry rate ${(retryRate * 100).toFixed(1)}% is CRITICAL`);\n  else if (retryRate >= kpiRules.retryRateWarn)\n    issues.push(`retry rate ${(retryRate * 100).toFixed(1)}% is high`);\n\n  if (retryRate >= kpiRules.retryRateWarn) {\n    actions.push(\"Investigate provider latency/timeouts (review timeoutMs and provider response times).\");\n    actions.push(\"If retries remain high, tune fallback policy or reduce maxAttempts to fail fast.\");\n  }\n\n  // Fallback\n  if (fallbackRate >= kpiRules.fallbackRateCritical)\n    issues.push(`fallback rate ${(fallbackRate * 100).toFixed(1)}% is CRITICAL`);\n  else if (fallbackRate >= kpiRules.fallbackRateWarn)\n    issues.push(`fallback rate ${(fallbackRate * 100).toFixed(1)}% is high`);\n\n  if (fallbackRate >= kpiRules.fallbackRateWarn) {\n    actions.push(\"Primary provider may be unstableâ€”check status, rate limits, and error responses.\");\n    actions.push(\"Consider routing traffic to secondary provider earlier or adding provider health checks.\");\n  }\n\n  // Recovery failures\n  if (recoveryFailRate >= kpiRules.recoveryFailRateCritical)\n    issues.push(`recovery fail rate ${(recoveryFailRate * 100).toFixed(1)}% is CRITICAL`);\n  else if (recoveryFailRate >= kpiRules.recoveryFailRateWarn)\n    issues.push(`recovery fail rate ${(recoveryFailRate * 100).toFixed(1)}% is high`);\n\n  if (recoveryFailRate >= kpiRules.recoveryFailRateWarn) {\n    actions.push(\"Recovery prompt may be weakâ€”review and strengthen the JSON repair prompt.\");\n    actions.push(\"Add golden tests for prompt outputs and consider a second repair strategy.\");\n  }\n\n  let status: HealthStatus = \"OK\";\n  if (issues.some((i) => i.includes(\"CRITICAL\"))) status = \"CRITICAL\";\n  else if (issues.length > 0) status = \"WARN\";\n\n  return { status, issues, actions };\n}\n"]}