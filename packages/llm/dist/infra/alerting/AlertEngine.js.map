{"version":3,"file":"AlertEngine.js","sourceRoot":"","sources":["../../../src/infra/alerting/AlertEngine.ts"],"names":[],"mappings":"AAMA,MAAM,OAAO,WAAW;IAIF;IAHZ,iBAAiB,GAAG,IAAI,GAAG,EAAkB,CAAC;IAC9C,UAAU,CAAS;IAE3B,YAAoB,QAAkB,EAAE,OAA2B,EAAE;QAAjD,aAAQ,GAAR,QAAQ,CAAU;QACpC,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,UAAU,IAAI,MAAM,CAAC,CAAC,gBAAgB;IAC/D,CAAC;IAED;;;OAGG;IACH,KAAK,CAAC,cAAc,CAAC,MAAsB;QACzC,IAAI,MAAM,CAAC,MAAM,KAAK,UAAU;YAAE,OAAO;QAEzC,MAAM,KAAK,GAAe;YACxB,IAAI,EAAE,qBAAqB;YAC3B,QAAQ,EAAE,UAAU;YACpB,OAAO,EAAE,8EAA8E;YACvF,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;YACrB,OAAO,EAAE;gBACP,OAAO,EAAE,MAAM,CAAC,OAAO,IAAI,EAAE;gBAC7B,MAAM,EAAE,MAAM,CAAC,MAAM,IAAI,EAAE;gBAC3B,IAAI,EAAE,MAAM,CAAC,IAAI,IAAI,EAAE;aACxB;SACF,CAAC;QAEF,MAAM,IAAI,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC;IACrC,CAAC;IAEO,KAAK,CAAC,gBAAgB,CAAC,KAAiB;QAC9C,MAAM,IAAI,GAAG,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACzD,MAAM,GAAG,GAAG,KAAK,CAAC,SAAS,CAAC;QAE5B,IAAI,GAAG,GAAG,IAAI,GAAG,IAAI,CAAC,UAAU;YAAE,OAAO;QAEzC,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,KAAK,CAAC,IAAI,EAAE,GAAG,CAAC,CAAC;QAC5C,MAAM,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;IACpC,CAAC;CACF","sourcesContent":["import type { AlertEvent, HealthSnapshot, Notifier } from \"./types\";\n\ntype AlertEngineOptions = {\n  cooldownMs?: number; // avoid spamming\n};\n\nexport class AlertEngine {\n  private lastFiredAtByName = new Map<string, number>();\n  private cooldownMs: number;\n\n  constructor(private notifier: Notifier, opts: AlertEngineOptions = {}) {\n    this.cooldownMs = opts.cooldownMs ?? 60_000; // 1 min default\n  }\n\n  /**\n   * MVP rule:\n   * - if health is CRITICAL -> fire alert (with cooldown)\n   */\n  async evaluateHealth(health: HealthSnapshot): Promise<void> {\n    if (health.status !== \"CRITICAL\") return;\n\n    const event: AlertEvent = {\n      name: \"LLM_HEALTH_CRITICAL\",\n      severity: \"critical\",\n      message: \"LLM pipeline health is CRITICAL (retries/timeouts/failures above threshold).\",\n      timestamp: Date.now(),\n      context: {\n        actions: health.actions ?? [],\n        issues: health.issues ?? [],\n        kpis: health.kpis ?? {},\n      },\n    };\n\n    await this.fireWithCooldown(event);\n  }\n\n  private async fireWithCooldown(event: AlertEvent): Promise<void> {\n    const last = this.lastFiredAtByName.get(event.name) ?? 0;\n    const now = event.timestamp;\n\n    if (now - last < this.cooldownMs) return;\n\n    this.lastFiredAtByName.set(event.name, now);\n    await this.notifier.notify(event);\n  }\n}\n"]}